<?xml version="1.0" ?>
<!DOCTYPE html>
<html lang="de" xml:lang="de" xmlns="http://www.w3.org/1999/xhtml">
<head>

    <meta charset="utf-8"/>

    <link rel="stylesheet" href="/static/styles.css">
    <!--    <link rel="icon" type="image/x-icon" href="favicon.ico" sizes="any">-->

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#000000">
    <meta name="theme-color" content="black">

    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="black">

    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>ftSwarm</title>

</head>

<body>
<div class="title center">
    <svg width="70mm" height="23mm" viewBox="0 0 264.56697 79.370058"
         enable-background="new 0 0 595.276 595.276">

        <g
                id="g42"
                transform="translate(-172.18119,-236.93309)">
            <defs
                    id="defs35">

                <rect
                        id="SVGID_1_"
                        x="283.905"
                        y="186.96001"
                        transform="matrix(-0.1736,-0.9848,0.9848,-0.1736,113.3257,598.4075)"
                        width="47.645"
                        height="129.395"/>
            </defs>
            <clipPath
                    id="SVGID_2_">
                <use
                        xlink:href="#SVGID_1_"
                        overflow="visible"
                        id="use37"
                        x="0"
                        y="0"
                        width="100%"
                        height="100%"/>
            </clipPath>
            <path
                    clip-path="url(#SVGID_2_)"
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="m 281.845,252.73 c 9.456,2.114 17.484,5.802 24.233,10.946 7.979,-7.091 17.396,-12.303 27.965,-16.087 10.569,-3.781 22.288,-6.137 34.874,-7.514 -11.133,-0.631 -22.161,-0.638 -33.052,0.707 -10.891,1.343 -21.646,4.041 -32.235,8.814 -0.434,0.197 -1.167,0.293 -1.898,0.302 -0.733,0.008 -1.468,-0.071 -1.906,-0.227 -7.599,-2.709 -15.713,-3.582 -24.219,-3.146 -8.506,0.436 -17.404,2.177 -26.571,4.699 12.465,-1.149 23.352,-0.608 32.809,1.506"
                    id="path40"/>
        </g>
        <g
                id="g52"
                transform="translate(-172.18119,-236.93309)">
            <defs
                    id="defs45">
                <rect
                        id="SVGID_3_"
                        width="595.276"
                        height="595.276"
                        x="0"
                        y="0"/>
            </defs>
            <clipPath
                    id="SVGID_4_">
                <!--suppress CheckEmptyScriptTag -->
                <use
                        xlink:href="#SVGID_3_"
                        overflow="visible"
                        id="use47"
                        x="0"
                        y="0"
                        width="100%"
                        height="100%"/>
            </clipPath>
            <path
                    clip-path="url(#SVGID_4_)"
                    d="m 430.97,281.497 c 0,-6.369 -3.501,-9.553 -10.502,-9.553 -4.209,0 -7.699,1.254 -10.47,3.762 -1.919,-2.508 -5.19,-3.762 -9.813,-3.762 -3.948,0 -7.241,1.025 -9.88,3.075 -0.196,-1.003 -0.438,-2.061 -0.72,-3.173 l -8.016,1.406 c 0.61,2.051 0.916,4.155 0.916,6.314 0,1.244 -0.055,2.16 -0.163,2.748 l -4.744,25.322 h 8.343 l 4.678,-25.06 c 0.786,-1.003 1.838,-1.892 3.157,-2.666 1.319,-0.774 2.503,-1.162 3.55,-1.162 3.468,0 5.202,1.135 5.202,3.403 0,0.284 -0.022,0.545 -0.066,0.785 l -4.645,24.7 h 8.375 l 4.678,-25.158 c 0.654,-0.916 1.646,-1.767 2.977,-2.552 1.33,-0.785 2.562,-1.178 3.697,-1.178 3.206,0 4.809,1.517 4.809,4.548 0,0.785 -0.065,1.527 -0.195,2.224 l -4.155,22.116 h 8.375 l 4.285,-22.966 c 0.216,-1.178 0.327,-2.235 0.327,-3.173 m -53.359,-8.932 c -2.312,-0.414 -3.915,-0.621 -4.809,-0.621 -3.513,0 -6.718,1.232 -9.619,3.697 l 0.557,-3.043 h -8.212 l -6.543,35.038 h 8.212 l 3.696,-19.793 c 0.458,-2.377 1.565,-4.487 3.321,-6.33 1.755,-1.843 3.69,-2.765 5.807,-2.765 1.483,0 3.195,0.72 5.136,2.16 z m -43.347,6.707 c -1.374,9.095 -2.939,15.093 -4.694,17.993 -1.756,2.901 -3.811,4.351 -6.167,4.351 -3.708,0 -5.561,-1.886 -5.561,-5.659 0,-4.559 1.09,-8.588 3.271,-12.089 2.182,-3.5 5.104,-5.25 8.769,-5.25 1.373,0 2.834,0.218 4.382,0.654 m 9.128,-5.692 c -2.617,-1.091 -6.881,-1.636 -12.792,-1.636 -6.129,0 -11.204,2.372 -15.229,7.115 -4.023,4.744 -6.035,10.442 -6.035,17.094 0,3.817 1.041,6.793 3.123,8.931 2.084,2.138 5.022,3.206 8.817,3.206 4.165,0 7.645,-1.386 10.437,-4.155 0.74,2.334 1.875,3.501 3.401,3.501 h 5.104 c -0.742,-1.788 -1.113,-5.082 -1.113,-9.88 0,-0.982 0.076,-1.876 0.229,-2.683 z m -34.155,-0.982 h -8.67 l -10.109,19.531 -5.79,-19.531 h -2.945 l -12.006,19.302 -3.5,-19.302 h -8.31 l 6.903,35.692 h 3.01 l 13.118,-20.25 6.118,20.25 H 290 Z m -54.274,-11.941 c -0.982,-0.458 -2.694,-0.867 -5.137,-1.227 -2.442,-0.359 -4.449,-0.539 -6.019,-0.539 -4.733,0 -8.561,1.287 -11.483,3.86 -2.923,2.574 -4.384,6.062 -4.384,10.469 0,1.134 0.153,2.236 0.458,3.304 0.305,1.069 0.763,2.11 1.374,3.124 0.611,1.014 1.194,1.805 1.75,2.372 0.557,0.567 1.62,1.483 3.19,2.748 l 5.136,4.089 c 2.792,2.182 4.188,4.177 4.188,5.987 0,1.832 -0.769,3.245 -2.307,4.237 -1.537,0.991 -3.473,1.487 -5.806,1.487 -3.861,0 -7.252,-1.101 -10.175,-3.304 L 223,305.673 c 3.817,1.854 7.873,2.781 12.17,2.781 5.235,0 9.493,-1.232 12.775,-3.697 3.283,-2.465 4.924,-5.889 4.924,-10.273 0,-1.133 -0.164,-2.246 -0.491,-3.337 -0.327,-1.09 -0.818,-2.17 -1.472,-3.238 -0.654,-1.069 -1.276,-1.903 -1.865,-2.503 -0.589,-0.6 -1.647,-1.554 -3.173,-2.863 l -4.94,-4.188 c -2.792,-2.334 -4.188,-4.34 -4.188,-6.02 0,-3.969 2.628,-5.954 7.885,-5.954 2.617,0 5.19,0.928 7.72,2.781 z m -53.29,37.369 c 0,3.262 0.839,5.777 2.519,7.543 1.68,1.769 4.082,2.652 7.207,2.652 3.145,0 5.567,-0.293 7.266,-0.879 v -6.739 c -1.523,0.958 -3.164,1.437 -4.922,1.437 -1.758,0 -2.988,-0.464 -3.691,-1.393 -0.703,-0.927 -1.055,-2.514 -1.055,-4.76 v -13.741 h 8.613 v -5.888 h -8.613 v -9.082 l -7.324,2.695 v 6.387 h -3.633 v 5.888 h 3.633 z m -3.632,-33.486 c -2.5,-0.762 -4.619,-1.143 -6.357,-1.143 -3.36,0 -6.099,1.182 -8.218,3.545 -2.12,2.364 -3.257,5.469 -3.413,9.317 h -4.6 v 6.035 h 4.57 v 25.342 h 7.325 v -25.342 h 6.386 v -6.035 h -6.504 c -0.019,-0.254 -0.029,-0.508 -0.029,-0.762 0,-1.738 0.484,-3.203 1.45,-4.395 0.967,-1.191 2.144,-1.787 3.531,-1.787 0.859,0 2.089,0.264 3.691,0.791 z"
                    id="path50"/>
        </g>
    </svg>
</div>
<div style="width:100%;height:100%" id="all">
</div>
<div class="small center">
    <br/>
    &nbsp; &copy; 2020-<span id="footer-year" onload="this.textContent = new Date().getFullYear()"></span> Christian Bergschneider & Stefan Fuss &nbsp;
    <br/>
</div>

<script type="text/javascript">
    /* base functions */

    let mouseDown = 0;
    document.body.onmousedown = function () {
        ++mouseDown;
    }
    document.body.onmouseup = function () {
        --mouseDown;
    }


    /* Functions for creating and updating Objects*/
    function buildFtSwarmObj(ftSwarm) {
        return `
<fieldset id="l-${ftSwarm["serialNumber"]}" class="swarm">
    <legend>${ftSwarm["name"]}</legend>
    <div style="width:100%;text-align: center">${ftSwarm["hostinfo"]}</div><br/>
    <div class="fields" id="INPUT-${ftSwarm["serialNumber"]}"></div><br />
    <div class="fields" id="BUTTON-${ftSwarm["serialNumber"]}"></div><br />
    <div class="fields" id="JOYSTICK-${ftSwarm["serialNumber"]}"></div><br />
    <div class="fields" id="ACTOR-${ftSwarm["serialNumber"]}"></div><br />
    <div class="fields" id="LED-${ftSwarm["serialNumber"]}"></div><br />
    <div class="fields" id="SERVO-${ftSwarm["serialNumber"]}"></div><br />
</fieldset>`
    }

    function buildTractorObject(io) {
        let selectElem = document.getElementById(io["id"] + "-coast");
        let valElem = document.getElementById(io["id"] + "-val");

        if (selectElem == null || valElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first">
        <span class="muted-upper">${io["subType"]}</span><br />
        <span>${io["name"]}:</span>
        <select class="in muted-upper-big select-actor"  id="${io["id"]}-coast" onchange="motModeListener(this)" name="${io["id"]}-mot">
            <option value="0">COAST</option>
            <option value="1">BRAKE</option>
            <option value="2">RUN</option>
        </select>

        <input type="range" id="${io["id"]}-val" min="-255" onchange="motPowerListener(this)" onmousemove="motPowerListenerMD(this)" max="255" step="1" value="${io["power"]}" style="width: 90%">
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;
        selectElem.value = io["motiontype"]
        valElem.value = io["power"]

        return ""
    }

    function buildMotorObject(io) {
        let valElem = document.getElementById(io["id"] + "-val");

        if (valElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first">
        <span class="muted-upper">${io["subType"]}</span><br />
        <span>${io["name"]}:</span>
        <input type="range" id="${io["id"]}-val" min="-255" onchange="motPowerListener(this)" onmousemove="motPowerListenerMD(this)" max="255" step="1" value="${io["power"]}" style="width: 90%">
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;
        valElem.value = io["power"]

        return ""
    }

    function buildLampObject(io) {
        let valElem = document.getElementById(io["id"] + "-val");

        if (valElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first">
        <span class="muted-upper">${io["subType"]}</span><br />
        <span>${io["name"]}:</span>
        <input type="range" id="${io["id"]}-val" min="0" onchange="motPowerListener(this)" onmousemove="motPowerListenerMD(this)" max="255" step="1" value="${io["power"]}" style="width: 90%">
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;
        valElem.value = io["power"]

        return ""
    }

    function buildActorObject(io) {
	
		switch( io["subType"] ) {
			case "LAMP": 
				return buildLampObject(io);
			case "TRACTORMOTOR":
				return buildTractorObject(io);
			case "ENCODERMOTOR":
				return buildTractorObject(io);
			default:
				return buildMotorObject(io);
		}
	
	}

    function buildLEDObject(io) {
        let colorElem = document.getElementById("value-" + io["id"])
        let brightnessElem = document.getElementById(io["id"] + "-br")

        if (colorElem == null || brightnessElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first">
        <span class="muted-upper">${io["type"]}</span><br />
        <span>${io["name"]}: <input id="value-${io["id"]}" type="color" onchange="ledColListener(this)" value="#${io["color"]}"></span>
        <input type="range" id="${io["id"]}-br" min="0" max="255" step="1" onchange="ledBrListener(this)" onmousemove="ledBrListenerMD(this)" value="${io["brightness"]}" style="width: 90%">
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;

        colorElem.value = "#" + io["color"]
        brightnessElem.value = io["brightness"]

        return ""
    }

    function buildServoObject(io) {
        let rangeElem = document.getElementById(io["id"] + "-val")

        if (rangeElem == null)
            return `
<fieldset class="type-input servo innerFields">
    <div class="first">
        <span class="muted-upper">${io["type"]}</span><br />
        <span>${io["name"]}</span><br />
        <input type="range" id="${io["id"]}-val" min="-255" max="255" step="1" onchange="servoListener(this)" onmousemove="servoListenerMD(this)" value="${io["value"]}" style="width: 90%">
    </div>
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;

        rangeElem.value = io["value"]

        return ""
    }

    function buildInputObject(io) {
        let valueElem = document.getElementById("value-" + io["id"])

        if (valueElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first in">
        <span class="muted-upper">${io["subType"]}</span><br />
        <span>${io["name"]}: <em id="value-${io["id"]}">${io["value"]}</em></span>
    </div>
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;

        valueElem.innerText = io["value"]
        return ""
    }

    function buildJoystickObject(io) {
        let lrElem = document.getElementById("value-" + io["id"] + "-LR")
        let fbElem = document.getElementById("value-" + io["id"] + "-FB")
        let btnElem = document.getElementById("value-" + io["id"])

        if (lrElem == null || fbElem == null || btnElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first in">
        <span class="muted-upper">${io["type"]}</span><br />
        <span>${io["name"]}: </span><br />
        <span>LR: <em id="value-${io["id"]}-LR">${io["valueLR"]}</em></span>
        <span>FB: <em id="value-${io["id"]}-FB">${io["valueFB"]}</em></span><br />
        <span>Button: <em id="value-${io["id"]}">${io["button"]}</em></span>
    </div>
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" class="red"/>
    </div>
</fieldset>
`;

        lrElem.innerText = io["valueLR"]
        fbElem.innerText = io["valueFB"]
        btnElem.innerText = io["button"]

        return ""
    }

    function buildButtonObject(io) {
        let valueElem = document.getElementById("value-" + io["id"])
        let statusElem = document.getElementById("status-" + io["id"])

        if (valueElem == null || statusElem == null)
            return `
<fieldset class="type-input innerFields">
    <div class="first in">
        <span class="muted-upper">${io["type"]}</span><br />
        <span>${io["name"]}: <em id="value-${io["id"]}">${io["state"]}</em></span>
    </div>
    </div>
    <div class="last">
        <img src="/static/${io["icon"]}" id="status-${io["id"]}" class="red"/>
    </div>
</fieldset>
`;

        valueElem.innerText = io["state"]

        let cl = statusElem.classList

        if (cl.contains("red"))
            cl.remove("red")
        if (cl.contains("teal"))
            cl.remove("teal")

        if (io["state"] === 1)
            cl.add("teal")
        else
            cl.add("red")

        return ""

    }

    let ledPayloads = {}
    let actorPayloads = {}
    let servoPayloads = {}

    /* Listener Backends */
    function ledColListener(t) {
        let payload = {}
        payload["id"] = t.id.slice(6)
        payload["color"] = parseInt(t.value.slice(1), 16)
        payload["brightness"] = Number(document.getElementById(payload["id"] + "-br").value)

        if (ledPayloads[payload["id"]] === undefined)
            ledPayloads[payload["id"]] = payload
        else
            ledPayloads[payload["id"]]["color"] = payload["color"]
    }

    function ledBrListener(t) {
        let payload = {}
        payload["id"] = t.id.substr(0, t.id.length - 3)
        payload["color"] = parseInt(document.getElementById("value-" + payload["id"]).value.slice(1), 16)
        payload["brightness"] = Number(t.value)

        if (ledPayloads[payload["id"]] === undefined)
            ledPayloads[payload["id"]] = payload
        else
            ledPayloads[payload["id"]]["brightness"] = payload["brightness"]
    }

    function ledBrListenerMD(t) {
        if (!mouseDown) return
        ledBrListener(t)
    }

    function motModeListenerOld(t) {
        let payload = {}
        payload["id"] = t.id.substr(0, t.id.length-6)
        payload["cmd"] = Number(t.value)
        payload["power"] = Number(document.getElementById(payload["id"] + "-val").value)

        if (actorPayloads[payload["id"]] === undefined)
            actorPayloads[payload["id"]] = payload
        else
            actorPayloads[payload["id"]]["cmd"] = payload["cmd"]
    }

    function motModeListener(t) {
        let payload = {}
        payload["id"] = t.id.substr(0, t.id.length - 4)
        /* payload["cmd"] = Number(document.getElementById(payload["id"] + "-val").value) */
		payload["cmd"] = Number(t.value)
        
        if (actorPayloads[payload["id"]] === undefined)
            actorPayloads[payload["id"]] = payload
        else
            actorPayloads[payload["id"]]["cmd"] = payload["cmd"]
    }

    function motPowerListener(t) {
        let payload = {}
        payload["id"] = t.id.substr(0, t.id.length - 4)
        payload["power"] = Number(t.value)

        if (actorPayloads[payload["id"]] === undefined)
            actorPayloads[payload["id"]] = payload
        else
            actorPayloads[payload["id"]]["power"] = payload["power"]
    }

    function motPowerListenerMD(t) {
        if (!mouseDown) return
        motPowerListener(t)
    }

    function servoListener(t) {
        let payload = {}
        payload["id"] = t.id.substr(0, t.id.length - 4)
        payload["offset"] = 0
        payload["position"] = Number(t.value)

        if (servoPayloads[payload["id"]] === undefined)
            servoPayloads[payload["id"]] = payload
        else
            servoPayloads[payload["id"]]["position"] = payload["position"]
    }

    function servoListenerMD(t) {
        if (!mouseDown) return
        servoListener(t)
    }

    function callback() {
        for (let ledPayloadKey in ledPayloads) {
            let payload = ledPayloads[ledPayloadKey]

            fetch("/api/led", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Powered-By': 'Electricity'
                },
                body: JSON.stringify(payload)
            }).catch(reason => {
                alert("Got an ftSwarm Communication Error: " + reason)
            })
            delete ledPayloads[ledPayloadKey]
        }
        for (let actorPayloadKey in actorPayloads) {
            let payload = actorPayloads[actorPayloadKey]

            fetch("/api/actor", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Powered-By': 'Electricity'
                },
                body: JSON.stringify(payload)
            }).catch(reason => {
                alert("Got an ftSwarm Communication Error: " + reason)
            })
            delete actorPayloads[actorPayloadKey]
        }
        for (let servoPayloadKey in servoPayloads) {
            let payload = servoPayloads[servoPayloadKey]

            fetch("/api/servo", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Powered-By': 'Electricity'
                },
                body: JSON.stringify(payload)
            }).catch(reason => {
                alert("Got an ftSwarm Communication Error: " + reason)
            })
            delete servoPayloads[servoPayloadKey]
        }
    }

    /* Is the website loaded already? Don't load again */
    let ran = false

    /*  Generalized Update Method for live-reloading input and/or output values */
    let update = function () {
        fetch("/api/getSwarm").then(async value => {
            let jsn = JSON.parse(await value.text());

            for (let i = 0; i < jsn.length; i++) {
                let jsnVal = jsn[i]

                if (!ran) {
                    document.getElementById("all").innerHTML += buildFtSwarmObj(jsnVal)
                    for (const ioPort of jsnVal["io"]) {
                        if (ioPort["type"] === "INPUT") {
                            document.getElementById("INPUT-" + jsnVal["serialNumber"]).innerHTML += buildInputObject(ioPort)
                        }
                        if (ioPort["type"] === "BUTTON") {
                            document.getElementById("BUTTON-" + jsnVal["serialNumber"]).innerHTML += buildButtonObject(ioPort)
                        }
                        if (ioPort["type"] === "JOYSTICK") {
                            document.getElementById("JOYSTICK-" + jsnVal["serialNumber"]).innerHTML += buildJoystickObject(ioPort)
                        }
                        if (ioPort["type"] === "ACTOR") {
                            document.getElementById("ACTOR-" + jsnVal["serialNumber"]).innerHTML += buildActorObject(ioPort)
                        }
                        if (ioPort["type"] === "LED") {
                            document.getElementById("LED-" + jsnVal["serialNumber"]).innerHTML += buildLEDObject(ioPort)
                        }
                        if (ioPort["type"] === "SERVO") {
                            document.getElementById("SERVO-" + jsnVal["serialNumber"]).innerHTML += buildServoObject(ioPort)
                        }
                    }
                }
                for (const ioPort of jsnVal["io"]) {
                    if (ioPort["type"] === "INPUT") {
                        buildInputObject(ioPort)
                    }
                    if (ioPort["type"] === "BUTTON") {
                        buildButtonObject(ioPort)
                    }
                    if (ioPort["type"] === "JOYSTICK") {
                        buildJoystickObject(ioPort)
                    }
                    if (ioPort["type"] === "ACTOR") {
                        buildActorObject(ioPort)
                    }
                    if (ioPort["type"] === "LED") {
                        buildLEDObject(ioPort)
                    }
                    if (ioPort["type"] === "SERVO") {
                        buildServoObject(ioPort)
                    }
                }
            }

            ran = true
        });
    }

    /* Load if not loaded; sets ran to True; could also be ommitted, but enables faster loading and securer placing of listeners */
    update()

    /* update values every second, works because ran=true at this point */
    /* setInterval(update, 1000) */

    /* call back to swarm every 0.8s */
    setInterval(callback, 800)
	
	document.getElementById("footer-year").onload()
</script>

</body>
</html>